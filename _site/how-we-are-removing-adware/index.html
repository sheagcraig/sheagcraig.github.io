<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>How We Are Removing Adware &#8211; Taco Destroyer</title>
<meta name="description" content="Over the last few months the number of mac laptops at our organization with
adware infections has slowly gone from nonexistent, to a slow trickle, to,
prior to the amelioration I’m about to describe, about 10% of our managed macs
having some blacklisted file present.

">
<meta name="keywords" content="">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="How We Are Removing Adware">
<meta name="twitter:description" content="Over the last few months the number of mac laptops at our organization with
adware infections has slowly gone from nonexistent, to a slow trickle, to,
prior to the amelioration I’m about to describe, about 10% of our managed macs
having some blacklisted file present.

">
<meta name="twitter:site" content="@shea_craig">


<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="How We Are Removing Adware">
<meta property="og:description" content="Over the last few months the number of mac laptops at our organization with
adware infections has slowly gone from nonexistent, to a slow trickle, to,
prior to the amelioration I’m about to describe, about 10% of our managed macs
having some blacklisted file present.

">
<meta property="og:url" content="/how-we-are-removing-adware/">
<meta property="og:site_name" content="Taco Destroyer">

<meta property="og:image" content="/images/default-thumb.png">






<link rel="canonical" href="/how-we-are-removing-adware/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Taco Destroyer Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="/assets/js/vendor/html5shiv.min.js"></script>
	<script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">Taco Destroyer</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="/posts/" >Sample Posts</a></li>
				
				    
				        
				    
				    <li><a href="/theme-setup/" >Theme Setup</a></li>
				
				    
				        
				        
				    <li><a href="http://mademistakes.com" target="_blank">Made Mistakes</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    
  

<div itemscope itemtype="http://schema.org/Person">


	<img src="/images/" class="bio-photo" alt=" bio photo">


  <h3 itemprop="name"></h3>
  <p></p>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="/how-we-are-removing-adware/" rel="bookmark" title="How We Are Removing Adware">How We Are Removing Adware</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Over the last few months the number of mac laptops at our organization with
adware infections has slowly gone from nonexistent, to a slow trickle, to,
prior to the amelioration I’m about to describe, about 10% of our managed macs
having some blacklisted file present.</p>

<p><strong>Update:</strong>All you reckless folks using 9.7 already, guess what? The “Execute
Command” described below doesn’t work. Stand by for a way to do this using a
script that is bulletproof.</p>

<p><strong>Update:</strong> It turns out that if you try to run yo from a Casper policy using
the Files and Processes/Execute Command task, yo will run, but never do
anything. I don’t quite grasp why this is, because it works if you login or ssh
in and do sudo jamf policy, but not if the trigger runs “naturally. Fortunately
@golby and I figured out an alternate. Use <code>open /Applications/Utilities/yo.app
--args -t "Adware Detected"</code> as your command (substitute your desired arguments
of course!). Updated in the post below as well.</p>

<p><strong>Update:</strong> People have been really enthusiastic about both
<a href="https://github.com/sheagcraig/yo">yo</a> and the AdwareCheck extension attribute.
So I started expanding AdwareCheck into something even better. Check out
<a href="https://github.com/sheagcraig/SavingThrow">SavingThrow</a> for more power!</p>

<p>I blogged about the first one of these adware packages that we’ve had to deal
with:
<a href="/cleaning-up-stupid-mac-malware-projectx/">here</a>.
Researching that, while fun, was also time consuming. Fortunately, Apple just
released <a href="https://support.apple.com/en-us/ht203987">an article</a> detailing files
to look for and procedures to use to remove common adware programs.</p>

<p>My todo list included several items like “write an extension attribute to
detect projectX” and “write automated removal script for projectX”. With
Apple’s KBase article, the research was all done; I just had to implement it.</p>

<p>And then, the prolific <a href="http://krypted.com/wp-content/uploads/2015/03/Allister.gif">Allister
Banks</a> taunted me
with his solution to detecting adware as an extension attribute. This was the
kick in the butt I needed.</p>

<p>So I wrote a quick one up myself that also adds in the ability to remove the
files. You can check it out
<a href="https://gist.github.com/sheagcraig/69a473f00ce434fffd5b">HERE</a></p>

<p>But that’s just the first piece of the puzzle. Now, what do we do with it? How
can you implement this procedure yourself?</p>

<p>First off, this procedure is based around us using the Casper Suite to manage
our fleet, but it is conceivable to use this method as a template for applying
to any other management system.</p>

<p>First, I added the AdwareCheckExtensionAttribute.py script to our JSS via the
Management Settings/Computer Management/Extension Attributes menu:</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Extension_Attributes.png" alt="Extension_Attributes" /></p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Extension_Attribute_AdwarePresent.png" alt="Edit_Extension_Attribute_AdwarePresent" /></p>

<p>Check the above screenshot for the correct extension attribute settings!</p>

<p>Next, I created a smart group to collect computers which had been identified as
<em>infected by dirty adware</em>:</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Screen-Shot-2015-03-25-at-11.31.28-AM.png" alt="Screen Shot 2015-03-25 at 11.31.28 AM" /></p>

<p>Notice, the criteria is that the value of AdwarePresent is <em>like</em> True. This is
because the extension attribute also reports back which specific files were
found, so it will never report back <em>exactly</em> True.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/ST-Loaner06.png" alt="ST-Loaner06" /></p>

<p>This is a nice added feature for IT; we like to be able to see what exactly the
user has acquired in their web surfing.</p>

<p>At this point, after computers start to recon, you should start to see some
results! Who has been handing out their admin privileges willy-nilly?</p>

<p>Now, on to how to excise the infection!</p>

<p>As a group, we decided to force the users to have to manually remove the adware
themselves. We felt that, unlike many of the Windows crapware that we see, our
Mac users had to actively authenticate and install these adware programs, and
this was our opportunity to do some targeted training. While we could have
automatically detected the adware and removed it without them ever knowing, we
felt like it was better to force them to become aware of the situation.</p>

<p>I have been working on another little project that displays OS X user
notifications. terminal-notifier already does this, but it does so rather
politely. I wanted a notification that wouldn’t go away until the user
interacted with it. So I wrote <a href="https://github.com/sheagcraig/yo">yo</a> in Swift.
The project includes an already built app that you can grab and install with no
screwing around. If you really really really want to use your organization’s
logo or some other icon AND ONLY that icon, yo has a README that details the
process of changing this icon and building the project.</p>

<p>The next step, then, was to craft a policy to install the yo app to
/Applications/Utilities on our fleet. I made a custom-build for our
organization that uses our logo, and deployed it across campus. Once that was
safely in place, it was time to remove some adware.</p>

<p>First, add the AdwareCheckExtensionAttribute.py file to your scripts through
Casper Admin or the Management/Computer Management/Scripts page so that it’s
available for your policy.</p>

<p>The next step was to create a Self Service policy named “Remove Adware”. Please
take a close look at the screenshots for the exact settings, and I’ll detail
the important bits below.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware.png" alt="Edit_Policy_Remove_Adware" /></p>

<p>Create a new policy, naming it something appropriate (Remove Adware?). Make
sure that it doesn’t trigger off of any of the general page triggers, since it
will be a self-service policy.</p>

<p>The frequency should be “Ongoing” because you want the policy to be available
as long as the user’s computer tests True for Adware.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware-2.png" alt="Edit_Policy_Remove_Adware 2" /></p>

<p>In the “Scripts” section, select the AdwareCheckExtensionAttribute.py script
and set the “Parameter 4” value to “ –remove”. This is how the script knows
its in removal mode vs. extension attribute mode.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware-4.png" alt="Edit_Policy_Remove_Adware 4" /></p>

<p>Next, add a Maintenance/Update Inventory task to the policy so that the
computer has a chance to drop out of the smart group.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware-3.png" alt="Edit_Policy_Remove_Adware 3" /></p>

<p>Finally, set the Maintenance/User Logged In Action to “Restart Immediately”.
Since some of the adware has multiple launchd jobs running, and it’s
complicated to remove them in the “correct” order, it’s much easier to just
force a restart on the user. (This will be addressed to the user in the Self
Service section to come…)</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware-5.png" alt="Edit_Policy_Remove_Adware 5" /></p>

<p>Scope the policy to the smart group you created above.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Remove_Adware-6.png" alt="Edit_Policy_Remove_Adware 6" /></p>

<p>Finally, in the Self Service tab, select “Make the policy available in Self
Service” toggle. I also set the button name and icon to be more helpful.</p>

<p>I put in a short description of what would happen, and, importantly, that it
would require a restart. I also selected the “Ensure that users view
description” to make sure that they are forced to “read” this description. I
put “read” in quotation marks because they won’t necessarily read it, but it’s
the best we can do!</p>

<p>Checking the “Feature the policy on the main page” button puts the policy front
and center for infected users. The best part is that this policy won’t show up
for computers not in the smart group, so you don’t have to worry about it
interfering with “normal” operation.</p>

<p>Once the self service policy has been created, anyone in the Adware smart group
can now remove their adware. Once all of the preceding work is done, the last
step is to notify the users that they have adware, hopefully directing them
towards Self Service.</p>

<p>Create one final policy, titled “Notify Users of Adware” or something similar.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Notify_user_of_Adware1.png" alt="Edit_Policy_Notify_user_of_Adware" /></p>

<p>Here, I selected the Recurring Check-In trigger. The notification won’t fire
off if the user is not logged in (which I could handle better in yo…), and
it also won’t work if we use the Login trigger, since it occurs before the UI
is fully set up. Trust me-recurring check-in is fine!</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Edit_Policy_Notify_user_of_Adware.png" alt="Edit_Policy_Notify_user_of_Adware" /></p>

<p>Next, set up a Maintenance/Execute Command task with the following call to yo:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">open /Applications/Utilities/yo.app --args -t <span class="s1">&#39;Adware detected&#39;</span> -b <span class="s1">&#39;Clean&#39;</span> -n <span class="s1">&#39;Please remove with Self Service: Remove Adware.&#39;</span> -a <span class="s1">&#39;/Applications/Self Service.app&#39;</span><span class="p">;</span>logger <span class="s1">&#39;Sending adware notification.&#39;</span></code></pre></div>

<p>The <code>-t</code> argument is the notification’s title, the <code>-b</code> sets the text on the
action button, and the <code>-n</code> argument sets the body text on the notification.
The <code>-a</code> is a path to the Self Service app. This is passed to the
<code>/usr/bin/open</code> commandline program as an argument; in our case, it says that,
when someone clicks on the notification’s “action” button (titled “Clean” in
this example), Self Service should be opened. The extra logger command at the
end has the dual purpose of logging to the system log and ensuring that our
policy exits 0, rather than failing due to a mysterious error.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Screen-Shot-2015-04-01-at-2.11.46-PM.png" alt="Screen Shot 2015-04-01 at 2.11.46 PM" /></p>

<p>And lastly, scope the policy to our adware smart group.</p>

<p>Once you hit save, computers who have been added to the smart group after their
last recon determined that they had an adware infection will have a policy
scoped to them to pop the notification on screen.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Screen-Shot-2015-04-01-at-2.06.12-PM.png" alt="Screen Shot 2015-04-01 at 2.06.12 PM" /></p>

<p>They can then click on the clean button, authenticate Self Service, and run the
Clean Adware policy to clean and reboot their computer.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/Self_Service_and_How_We_Are_Removing_Adware___Shea_Craig.png" alt="Screenshot" /></p>

<p>This is all well and good… But to take it to the next level, maybe I’ll write
a JSS recipe so that you can AutoPkg/JSSImporter this entire procedure to your
JSS with no other work than running the recipe.</p>

<p><img src="/images/2015-03-25-how-we-are-removing-adware/tumblr_n0dspuc1Yx1trues8o1_500.gif" alt="Screenies." /></p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=/how-we-are-removing-adware/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=/how-we-are-removing-adware/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/how-we-are-removing-adware/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>How We Are Removing Adware</strong> was published on <time datetime="2015-03-25T12:23:21-04:00">March 25, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="/putting-the-hopper-to-work-broken-preferences-edition/" title="Putting the Hopper to Work: Broken Preferences Edition">Putting the Hopper to Work: Broken Preferences Edition</a></li>
    
      <li><a href="/now-i-get-it-updating-mac-firmware/" title="Now I get it... Updating Mac firmware">Now I get it... Updating Mac firmware</a></li>
    
      <li><a href="/how-i-roll/" title="How I Roll">How I Roll</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>&copy; 2015 Shea Craig. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


  



</body>
</html>
