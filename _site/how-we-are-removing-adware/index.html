<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>How We Are Removing Adware &#8211; Taco Destroyer</title>
<meta name="description" content="Over the last few months the number of mac laptops at our organization with adware infections has slowly gone from nonexistent, to a slow trickle, to, prior to the amelioration I’m about to describe, about 10% of our managed macs having some blacklisted file present.

">
<meta name="keywords" content="">

  

<!-- Twitter Cards -->
<meta name="twitter:title" content="How We Are Removing Adware">
<meta name="twitter:description" content="Over the last few months the number of mac laptops at our organization with adware infections has slowly gone from nonexistent, to a slow trickle, to, prior to the amelioration I’m about to describe, about 10% of our managed macs having some blacklisted file present.

">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="How We Are Removing Adware">
<meta property="og:description" content="Over the last few months the number of mac laptops at our organization with adware infections has slowly gone from nonexistent, to a slow trickle, to, prior to the amelioration I’m about to describe, about 10% of our managed macs having some blacklisted file present.

">
<meta property="og:url" content="http://localhost:4000/how-we-are-removing-adware/">
<meta property="og:site_name" content="Taco Destroyer">





<link rel="canonical" href="http://localhost:4000/how-we-are-removing-adware/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Taco Destroyer Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		        
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/articles/" >Articles</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/theme-setup/" >Theme Setup</a></li>
		  
		    
		        
		        
		    <li><a href="http://mademistakes.com" target="_blank">Made Mistakes</a></li>
		  
		    
		        
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="http://localhost:4000/" class="site-logo" rel="home" title="Taco Destroyer"><img src="http://localhost:4000/images/site-logo.png" width="200" height="200" alt="Taco Destroyer logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">Taco Destroyer</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Describe your website here.</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <span class="entry-tags"></span>
        
          <h1 class="entry-title">How We Are Removing Adware</h1>
        
      </header>
      <footer class="entry-meta">
        
          
        
        <span class="author vcard">By <span class="fn"></span></span>
        <span class="entry-date date published"><time datetime="2015-03-25T12:23:21-04:00"><i class="fa fa-calendar-o"></i> March 25, 2015</time></span>
        
        
        
        
      </footer>
      <div class="entry-content">
        <p>Over the last few months the number of mac laptops at our organization with adware infections has slowly gone from nonexistent, to a slow trickle, to, prior to the amelioration I’m about to describe, about 10% of our managed macs having some blacklisted file present.</p>

<p><strong>Update:</strong>All you reckless folks using 9.7 already, guess what? The “Execute Command” described below doesn’t work. Stand by for a way to do this using a script that is bulletproof.</p>

<p><strong>Update:</strong> It turns out that if you try to run yo from a Casper policy using the Files and Processes/Execute Command task, yo will run, but never do anything. I don’t quite grasp why this is, because it works if you login or ssh in and do sudo jamf policy, but not if the trigger runs “naturally. Fortunately @golby and I figured out an alternate. Use <code>open /Applications/Utilities/yo.app --args -t "Adware Detected"</code> as your command (substitute your desired arguments of course!). Updated in the post below as well.</p>

<p><strong>Update:</strong> People have been really enthusiastic about both <a href="https://github.com/sheagcraig/yo">yo</a> and the AdwareCheck extension attribute. So I started expanding AdwareCheck into something even better. Check out <a href="https://github.com/sheagcraig/SavingThrow">SavingThrow</a> for more power!</p>

<p>I blogged about the first one of these adware packages that we’ve had to deal with: <a href="http://labs.da.org/wordpress/sheagcraig/2015/01/21/cleaning-up-stupid-mac-malware-projectx/">here</a>. Researching that, while fun, was also time consuming. Fortunately, Apple just released <a href="https://support.apple.com/en-us/ht203987">an article</a> detailing files to look for and procedures to use to remove common adware programs.</p>

<p>My todo list included several items like “write an extension attribute to detect projectX” and “write automated removal script for projectX”. With Apple’s KBase article, the research was all done; I just had to implement it.</p>

<p>And then, the prolific <a href="http://krypted.com/wp-content/uploads/2015/03/Allister.gif">Allister Banks</a> taunted me with his solution to detecting adware as an extension attribute. This was the kick in the butt I needed.</p>

<p>So I wrote a quick one up myself that also adds in the ability to remove the files. You can check it out <a href="https://gist.github.com/sheagcraig/69a473f00ce434fffd5b">HERE</a></p>

<p>But that’s just the first piece of the puzzle. Now, what do we do with it? How can you implement this procedure yourself?</p>

<p>First off, this procedure is based around us using the Casper Suite to manage our fleet, but it is conceivable to use this method as a template for applying to any other management system.</p>

<p>First, I added the AdwareCheckExtensionAttribute.py script to our JSS via the Management Settings/Computer Management/Extension Attributes menu:
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Extension_Attributes.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Extension_Attributes.png" alt="Extension_Attributes" /></a>
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Extension_Attribute_AdwarePresent.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Extension_Attribute_AdwarePresent.png" alt="Edit_Extension_Attribute_AdwarePresent" /></a>
Check the above screenshot for the correct extension attribute settings!</p>

<p>Next, I created a smart group to collect computers which had been identified as <em>infected by dirty adware</em>:
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-03-25-at-11.31.28-AM.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-03-25-at-11.31.28-AM.png" alt="Screen Shot 2015-03-25 at 11.31.28 AM" /></a></p>

<p>Notice, the criteria is that the value of AdwarePresent is <em>like</em> True. This is because the extension attribute also reports back which specific files were found, so it will never report back <em>exactly</em> True.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/ST-Loaner06.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/ST-Loaner06.png" alt="ST-Loaner06" /></a></p>

<p>This is a nice added feature for IT; we like to be able to see what exactly the user has acquired in their web surfing.</p>

<p>At this point, after computers start to recon, you should start to see some results! Who has been handing out their admin privileges willy-nilly?</p>

<p>Now, on to how to excise the infection!</p>

<p>As a group, we decided to force the users to have to manually remove the adware themselves. We felt that, unlike many of the Windows crapware that we see, our Mac users had to actively authenticate and install these adware programs, and this was our opportunity to do some targeted training. While we could have automatically detected the adware and removed it without them ever knowing, we felt like it was better to force them to become aware of the situation.</p>

<p>I have been working on another little project that displays OS X user notifications. terminal-notifier already does this, but it does so rather politely. I wanted a notification that wouldn’t go away until the user interacted with it. So I wrote <a href="https://github.com/sheagcraig/yo">yo</a> in Swift. The project includes an already built app that you can grab and install with no screwing around. If you really really really want to use your organization’s logo or some other icon AND ONLY that icon, yo has a README that details the process of changing this icon and building the project.</p>

<p>The next step, then, was to craft a policy to install the yo app to /Applications/Utilities on our fleet. I made a custom-build for our organization that uses our logo, and deployed it across campus. Once that was safely in place, it was time to remove some adware.</p>

<p>First, add the AdwareCheckExtensionAttribute.py file to your scripts through Casper Admin or the Management/Computer Management/Scripts page so that it’s available for your policy.</p>

<p>The next step was to create a Self Service policy named “Remove Adware”. Please take a close look at the screenshots for the exact settings, and I’ll detail the important bits below.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware.png" alt="Edit_Policy_Remove_Adware" /></a>
Create a new policy, naming it something appropriate (Remove Adware?). Make sure that it doesn’t trigger off of any of the general page triggers, since it will be a self-service policy.</p>

<p>The frequency should be “Ongoing” because you want the policy to be available as long as the user’s computer tests True for Adware.</p>

<p><a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-2.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-2.png" alt="Edit_Policy_Remove_Adware 2" /></a>
In the “Scripts” section, select the AdwareCheckExtensionAttribute.py script and set the “Parameter 4” value to “
–remove”. This is how the script knows its in removal mode vs. extension attribute mode.</p>

<p><a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-4.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-4.png" alt="Edit_Policy_Remove_Adware 4" /></a>
Next, add a Maintenance/Update Inventory task to the policy so that the computer has a chance to drop out of the smart group.</p>

<p><a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-3.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-3.png" alt="Edit_Policy_Remove_Adware 3" /></a>
Finally, set the Maintenance/User Logged In Action to “Restart Immediately”. Since some of the adware has multiple launchd jobs running, and it’s complicated to remove them in the “correct” order, it’s much easier to just force a restart on the user. (This will be addressed to the user in the Self Service section to come…)</p>

<p><a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-5.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-5.png" alt="Edit_Policy_Remove_Adware 5" /></a>
Scope the policy to the smart group you created above.</p>

<p><a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-6.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Remove_Adware-6.png" alt="Edit_Policy_Remove_Adware 6" /></a>
Finally, in the Self Service tab, select “Make the policy available in Self Service” toggle. I also set the button name and icon to be more helpful.</p>

<p>I put in a short description of what would happen, and, importantly, that it would require a restart. I also selected the “Ensure that users view description” to make sure that they are forced to “read” this description. I put “read” in quotation marks because they won’t necessarily read it, but it’s the best we can do!</p>

<p>Checking the “Feature the policy on the main page” button puts the policy front and center for infected users. The best part is that this policy won’t show up for computers not in the smart group, so you don’t have to worry about it interfering with “normal” operation.</p>

<p>Once the self service policy has been created, anyone in the Adware smart group can now remove their adware. Once all of the preceding work is done, the last step is to notify the users that they have adware, hopefully directing them towards Self Service.</p>

<p>Create one final policy, titled “Notify Users of Adware” or something similar.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Notify_user_of_Adware1.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Notify_user_of_Adware1.png" alt="Edit_Policy_Notify_user_of_Adware" /></a>
Here, I selected the Recurring Check-In trigger. The notification won’t fire off if the user is not logged in (*which I could handle better in yo…), and it also won’t work if we use the Login trigger, since it occurs before the UI is fully set up. Trust me-recurring check-in is fine!
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Notify_user_of_Adware.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Edit_Policy_Notify_user_of_Adware.png" alt="Edit_Policy_Notify_user_of_Adware" /></a>
Next, set up a Maintenance/Execute Command task with the following call to yo:</p>

<pre><code>open /Applications/Utilities/yo.app --args -t 'Adware detected' -b 'Clean' -n 'Please remove with Self Service: Remove Adware.' -a '/Applications/Self Service.app';logger 'Sending adware notification.'
</code></pre>

<p>The <code>-t</code> argument is the notification’s title, the <code>-b</code> sets the text on the action button, and the <code>-n</code> argument sets the body text on the notification. The <code>-a</code> is a path to the Self Service app. This is passed to the <code>/usr/bin/open</code> commandline program as an argument; in our case, it says that, when someone clicks on the notification’s “action” button (titled “Clean” in this example), Self Service should be opened. The extra logger command at the end has the dual purpose of logging to the system log and ensuring that our policy exits 0, rather than failing due to a mysterious error.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-04-01-at-2.11.46-PM.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-04-01-at-2.11.46-PM.png" alt="Screen Shot 2015-04-01 at 2.11.46 PM" /></a>
And lastly, scope the policy to our adware smart group.</p>

<p>Once you hit save, computers who have been added to the smart group after their last recon determined that they had an adware infection will have a policy scoped to them to pop the notification on screen.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-04-01-at-2.06.12-PM.png"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/Screen-Shot-2015-04-01-at-2.06.12-PM.png" alt="Screen Shot 2015-04-01 at 2.06.12 PM" /></a>
They can then click on the clean button, authenticate Self Service, and run the Clean Adware policy to clean and reboot their computer.
[![Self_Service_and_How_We_Are_Removing_Adware<strong><em>Shea_Craig](http://labs.da.org/wordpress/sheagcraig/files/2015/03/Self_Service_and_How_We_Are_Removing_Adware</em>__Shea_Craig.png)](http://labs.da.org/wordpress/sheagcraig/files/2015/03/Self_Service_and_How_We_Are_Removing_Adware</strong>_Shea_Craig.png)</p>

<p>This is all well and good… But to take it to the next level, maybe I’ll write a JSS recipe so that you can AutoPkg/JSSImporter this entire procedure to your JSS with no other work than running the recipe.
<a href="http://labs.da.org/wordpress/sheagcraig/files/2015/03/tumblr_n0dspuc1Yx1trues8o1_500.gif"><img src="http://labs.da.org/wordpress/sheagcraig/files/2015/03/tumblr_n0dspuc1Yx1trues8o1_500.gif" alt="tumblr_n0dspuc1Yx1trues8o1_500" /></a></p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/cleaning-up-stupid-mac-malware-projectx/" class="btn" title="Cleaning up stupid Mac malware: "ProjectX"">Previous</a>
      
      
        <a href="http://localhost:4000/shout-out/" class="btn" title="Shout out!">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2015 Your Name. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/so-simple/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	
	
	
	
	
	
	
	
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>




</body>
</html>
